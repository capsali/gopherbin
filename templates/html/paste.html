<!DOCTYPE html>
<html lang="en" >
{{template "header"}}
<body>
    {{template "navbar" dict "UserInfo" .UserInfo }}
	<div class="container-fluid pt-xl-5">
        <div class="col-sm-12 code-div">
            <div class="row">
            {{ if .Error }}
                <div class="col-sm-12">
                    <h2>{{ .Error }}</h2>
                </div>
            </div>
            {{else}}
                <div class="col-sm-12">
                    <h2> {{.Paste.Name }}</h2>
                </div>
            </div>

            <div class="row">
                <div class="col-sm-12">
                    <p>Created by <strong>{{.UserInfo.FullName}}</strong></p>
                </div>
            </div>
            {{ if .Paste.Encrypted }}
            <div class="row">
                <div class="col-sm-12">
                    <div class="form-group" id="unlock">
                        <p>You need a passphrase to decrypt this content</p>
                        <input type="password" name="passphrase">
                        <button type="button" name="decrypt" class="btn btn-primary">Decrypt</button>
                    </div>
                </div>
            </div>
            {{end}}

            {{if .Paste.Encrypted}}
            <textarea name="encrypted-paste" style="display:none">{{asString .Paste.Data}}</textarea>
            {{else}}
            
            <div class="row">
                <div class="col-sm-2">
                    <button name="copy-paste" data-toggle="tooltip" class="btn btn-secondary" title="Copied!">Copy</button>
                </div>
            </div>

            <div class="row">
                <div class="col-sm-12">
                    <pre name="paste-data">
                        {{if .Paste.Language}}<code class="{{.Paste.Language}} overflow-wrap">{{asString .Paste.Data}}</code>{{else}}<code class="overflow-wrap">{{asString .Paste.Data}}</code>{{end}}
                    </pre>
                </div>
            </div>
            {{end}}
            {{end}}
        </div>
    </div>
    <script>
        function setTooltip(message) {
            $('[data-toggle="tooltip"]').tooltip('hide')
                .attr('data-original-title', message)
                .tooltip('show');
        }

        function hideTooltip() {
            setTimeout(function() {
                $('[data-toggle="tooltip"]').tooltip('hide');
            }, 1000);
        }

        function getEOL () {
                var aPlatform = navigator.platform.toLowerCase();
                if(aPlatform.indexOf('win') != -1) {
                    return "\r\n";
                } else if(aPlatform.indexOf('mac') != -1) {
                    return "\r";
                } else if(aPlatform.indexOf('unix') != -1 || aPlatform.indexOf('linux') != -1 || aPlatform.indexOf('sun') != -1) {
                    return "\n"; // nix
                } else {
                    return "\n";
                }
            }

            function textToClipboard (text) {
                var dummy = document.createElement("textarea");
                dummy.style = "position: absolute; left: -1000px; top: -1000px";
                dummy.value = text;
                document.body.appendChild(dummy);
                dummy.select();
                dummy.setSelectionRange(0, 999999);
                document.execCommand("copy");
                document.body.removeChild(dummy);
            }

        function initAllTheThings() {
            var pres = document.querySelectorAll("pre>code");
            for (var i = 0; i < pres.length; i++) {
                hljs.highlightBlock(pres[i]);
            }

            $('code.hljs').each(function(i, block) {
                hljs.lineNumbersBlock(block, {singleLine: true});
            });

            $('[data-toggle="tooltip"]').tooltip({
                trigger : 'click'
            }); 

            $('button[name="copy-paste"]').on('click', function () {
                var pasteData = $('pre[name="paste-data"]');
                var pasteContents = "";
                var childNodes = pasteData.children();
                if (childNodes.length > 0) {
                    var codeNode = childNodes[0];
                    if (codeNode.nodeName === 'CODE') {
                        var codeChild = codeNode.childNodes[0];
                        if (codeChild.nodeName === 'TABLE') {
                            for (var i=0; i < codeChild.rows.length; i++){
                                pasteContents += codeChild.rows[i].textContent + getEOL();
                            }
                        } else {
                            pasteContents = codeChild.textContent;
                        }
                    }
                }

                textToClipboard(pasteContents);
                setTooltip("Copied!");
                hideTooltip();
            });
        }

        var preContainer = $('pre[name="paste-data"]');
        if (preContainer.length) {
            initAllTheThings();
        }

        $(document).ready(function(){
            $('button[name="decrypt"]').on('click', function () {
                var $passphrase = $('input[name="passphrase"]');
                var hash = sha256.create();
                hash.update($passphrase.val());
                var key = hash.array();

                var $pasteEnc = $('textarea[name="encrypted-paste"]');
                var encText = $pasteEnc.val();

                var aesCtr = new aesjs.ModeOfOperation.ctr(key);
                var textBytes = aesjs.utils.hex.toBytes(encText);

                var decBytes =  aesCtr.decrypt(textBytes);
                var decryptedText = aesjs.utils.utf8.fromBytes(decBytes);

                var preContainer = $('.removeme');
                if (preContainer.length) {
                    preContainer.remove()
                }
                $('.code-div').append(
                    `<div class="row removeme">
                        <div class="col-sm-2">
                            <button name="copy-paste" data-toggle="tooltip" class="btn btn-secondary" title="Copied!">Copy</button>
                        </div>
                    </div>
                    <div class="row removeme">
                        <div class="col-sm-12">
                            <pre name="paste-data" style="display:none;">
                                <code class="overflow-wrap">` + escapeHTML(decryptedText) + `</code>
                            </pre>
                        </div>
                    </div>`);

                $prePaste = $('pre[name="paste-data"]');

                initAllTheThings();
                $prePaste.fadeIn();
            });
        });
    </script>
</body>

</html>
